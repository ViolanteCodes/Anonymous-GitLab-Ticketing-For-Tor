{% extends 'shared/layout.html' %}
{% load static %}
{% block h3 %}
  Anon Ticket
{% endblock %}
{% block subheader %} 
  Search for an issue on GitLab.
{% endblock %}
<!-- Extra links block for pages that have a user_identifier piped to them.-->
{% block extra_links %}
  {% include 'shared/extend_sidebar.html' %}
{% endblock %}

{% block content %}
<!-- Introductory Information -->
<div class="row">
  <div class="col-12">
    <p class="p-3">
      This form uses the GitLab API to search for issues for those
      projects in the dropdown below (which currently accept issues
      and comments via this anonymous portal.) To see all of Tor's 
      public projects and issues, you can visit the 
      <a href="https://gitlab.torproject.org/tpo">
        TorProject GitLab site</a>.
    </p>
    <p class="p-3">
      Once you find an issue, you can create a comment on that issue's
      detail page. All comments are held in a 
      pending status until they're approved by
      a moderator. You can check the status of your issue at any time
      on 
      {% url 'user-landing' results.user_identifier as landing_url %}
      <a href="{{landing_url}}">your landing page,</a>
      where it will be marked with asterisks
      (***) if it is still pending.
    </p>
  </div>
</div>

<!-- Results Rendering -->
{% if results.status %}
<div class="row">
  <div class="col-12 mb-3">
      <h3 class="mt-3">Result of this lookup was: <mark>{{results.status|title}}</mark></h3>
      <p>{{results.message}}</p> 
        {% if results.matching_project %}
          {% with project=results.matching_project %}
          <ul class="list-unstyled">
            <li class="ml-2">
              <h6 class="d-inline">Project Details</h6>: {{project.name}} 
            </li>
            <li class="ml-2">
              <h6 class="d-inline">Project Description:</h6> {{project.description}}
            </li>
            <li class="ml-2">
              <h6 class="d-inline">Note</h6>: (If you didn't find what you were looking for, you can see this project's page on TorProject's
              GitLab account for advanced search functions, or you can enter a new search string below and try again.)
            </li>
          </ul>
      {% endwith %}
      {% endif %}
  </div>
</div>
{% if results.matching_issues %}
<div class="row">
  <div class="col-12">
    <div class="bg-light ml-3 mr-3 p-4 form-control"> 
      <h4>Issues Matching Your Search String</h4>
      <ul>
        {% for issue in results.matching_issues %}
          {% url 'issue-detail-view' results.user_identifier issue.project_id issue.iid as issue_url %}
        <li class="mb-1"><a href="{{issue_url}}">{{issue.title}}</a>: {{issue.description|truncatewords:20}}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endif %}
<div class="row">
  <div class="col-12">
    <p class="mt-3">
      You can enter a new search string below and try again, or visit the TorProject GitLab page.
    </p>
  </div>
</div>
{% endif %}

<!-- Form Rendering -->
<div class="row">
  <div class="col-12">
    <form class="bg-light p-4 form-control ml-3 mr-3" method="get">
      <!--Loop over form fields, allowing for custom styling. Help-text 
      and custom labels/descriptions are taken from forms.py-->
      {% for field in form %}
        <div class="fieldWrapper form-group">
          {{ field.errors }}
      
        <div class="row">
          <div class="col-12">
            <div class="mb-0">{{ field.label_tag }}</div>
          </div>
        </div>

        {% if field.help_text %}
        <div class="row">
          <div class="col-12">
            <div class="help small p-0 text-muted mb-2">
              {{ field.help_text|safe }}
            </div>
          </div>
        </div>
        {% endif %}

        <div class="row">
          <div class="col-12">
            <div class="flex-form mb-3">{{ field }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
      <button type="submit" class="btn btn-lg btn-primary mr-2">SEARCH</button>
    </form>
  </div>
</div>
<!-- End Form Rendering -->

{% endblock %}